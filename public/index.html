<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Canva Studio üé®</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #ffffff; font-family: system-ui, sans-serif; transition: background-color 0.3s ease; }
        
        /* üêõ BUG FIX: Papers now use attributes so they don't break Dark Mode! */
        body[data-paper="bg-lined"] { background-image: repeating-linear-gradient(transparent, transparent 29px, rgba(0,0,0,0.1) 29px, rgba(0,0,0,0.1) 30px); }
        body[data-paper="bg-grid"] { background-image: linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px); background-size: 30px 30px; }
        body[data-paper="bg-dots"] { background-image: radial-gradient(rgba(0,0,0,0.2) 2px, transparent 2px); background-size: 30px 30px; }
        body[data-paper="bg-vintage"] { background-color: #f4ecd8 !important; background-image: radial-gradient(#d3c5a3 1px, transparent 1px); background-size: 20px 20px; }
        body[data-paper="bg-blueprint"] { background-color: #1a4a76 !important; background-image: linear-gradient(rgba(255,255,255,0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 30px 30px; }
        body[data-paper="bg-kraft"] { background-color: #dcb68a !important; }

        canvas { display: block; background-color: transparent; position: absolute; top:0; left:0; }
        #scratchBoard { pointer-events: none; z-index: 1; }
        #laserBoard { pointer-events: none; z-index: 2; }
        
        /* THE OBJECT LAYER & NEW RESIZE HANDLE */
        #objectLayer { position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none; z-index: 3; }
        .canvas-obj { position: absolute; pointer-events: auto; transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 2px solid transparent; transform-origin: center center; }
        .canvas-obj.text-obj { padding: 10px; background: transparent; white-space: nowrap; box-shadow: none; text-shadow: 0px 2px 4px rgba(0,0,0,0.3); }
        .canvas-obj.img-obj { border-radius: 10px; background: white; padding: 10px; padding-bottom: 30px; }
        .canvas-obj.selected { border: 2px dashed #ff4d85; cursor: grab; }
        
        .delete-btn { display: none; position: absolute; top: -15px; left: -15px; background: #ff4d85; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); pointer-events: auto; }
        .resize-btn { display: none; position: absolute; bottom: -15px; right: -15px; background: #4facfe; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-weight: bold; font-size: 18px; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); pointer-events: auto; touch-action: none; }
        .canvas-obj.selected .delete-btn, .canvas-obj.selected .resize-btn { display: flex; }

        /* UI Toolbars */
        .top-bar { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; z-index: 10; width:max-content; }
        .bottom-nav { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); display: flex; gap: 15px; z-index: 11; width: 90%; max-width: 350px; justify-content: space-around; }
        .nav-btn { font-size: 14px; font-weight: bold; padding: 10px; border-radius: 20px; border: none; background: transparent; color: #555; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .nav-btn.active-nav { color: #ff4d85; background: #ffe6ee; }
        .sub-bar { position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; gap: 15px; align-items: center; z-index: 10; max-width: 90%; overflow-x: auto; white-space: nowrap; }
        .sub-bar.show { display: flex; }
        .sub-bar::-webkit-scrollbar { display: none; }
        .tool-group { display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: bold; color: #555; gap: 4px; }
        button.tool-btn { padding: 10px; border: none; border-radius: 50%; font-size: 18px; width: 45px; height: 45px; cursor: pointer; background-color: #f0f0f0; box-shadow: inset 0 2px 4px rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.1); }
        button.tool-btn:active { transform: scale(0.9); }
        .active-tool { background-color: #333 !important; color: white !important; box-shadow: 0 0 10px rgba(0,0,0,0.3) !important; }
        
        .settings-modal { display: none; position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); padding: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 20; flex-direction: column; gap: 15px; min-width: 200px; }
        .settings-modal.show { display: flex; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #333; font-size: 14px; gap: 10px; }
        .setting-row button { border-radius: 10px; width: auto; height: auto; padding: 8px 15px; font-size: 14px; background: #eee; border:none; }
        .template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .template-btn { width: 100%; height: 60px; border-radius: 10px; border: 2px solid #ddd; background: white; font-size: 24px; display: flex; align-items: center; justify-content: center; border:none; }
        
        input[type="color"] { -webkit-appearance: none; border: 2px solid #ddd; width: 40px; height: 40px; padding: 0; border-radius: 50%; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; } input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        input[type="range"] { width: 80px; accent-color: #333; }
        select { font-size: 12px; padding: 5px; border: 1px solid #ccc; border-radius: 5px; background: white; outline: none; font-weight:bold; color:#333; }
        #shapePicker, #emojiPicker { font-size: 18px; border: none; background: transparent; padding:0; }
        #imageLoader { display: none; }
        #textInput { border: 2px solid #ddd; border-radius: 15px; padding: 5px 10px; width: 90px; font-size: 14px; outline: none; }
        
        body.dark-ui .top-bar, body.dark-ui .sub-bar, body.dark-ui .bottom-nav, body.dark-ui .settings-modal, body.dark-ui #chatBox { background: rgba(30, 30, 30, 0.9); color: #fff; }
        body.dark-ui .tool-group, body.dark-ui .setting-row, body.dark-ui .nav-btn { color: #ccc; }
        body.dark-ui button.tool-btn { background-color: #444; color: #fff; }
        body.dark-ui .active-tool, body.dark-ui .active-nav { background-color: #4facfe !important; color:white; }
        body.dark-ui select { background: #444; color:white; border:none; }

        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffebf0; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #loginScreen h1 { color: #ff4d85; margin-bottom: 20px; text-align: center; }
        .login-field { padding: 15px; font-size: 16px; border-radius: 20px; border: 2px solid #ff4d85; outline: none; text-align: center; margin-bottom: 15px; width: 250px; }
        #loginBtn { border-radius: 20px; width: 150px; padding:15px; background: #ff4d85; color: white; font-weight: bold; border:none; }

        #liveChatContainer { position: absolute; bottom: 150px; left: 10px; width: 250px; height: 300px; display: flex; flex-direction: column; justify-content: flex-end; z-index: 12; pointer-events: none; }
        #liveChatMessages { display: flex; flex-direction: column; gap: 5px; overflow-y: hidden; margin-bottom: 10px; align-items: flex-start; }
        .live-msg { background: rgba(0, 0, 0, 0.4); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; word-wrap: break-word; max-width: 100%; animation: slideIn 0.3s ease-out; transition: opacity 1s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-out { opacity: 0; }
        #liveChatInputArea { pointer-events: auto; display: flex; gap: 5px; background: rgba(255,255,255,0.3); backdrop-filter: blur(5px); padding: 5px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.5); }
        #liveChatInput { flex: 1; background: transparent; border: none; outline: none; color: #333; padding: 5px 10px; font-weight: bold; }
        #liveSendBtn { background: #ff4d85; color: white; border-radius: 15px; padding: 5px 15px; font-size: 12px; border:none; }
        .love-heart { position: absolute; font-size: 35px; pointer-events: none; z-index: 999; animation: fall 3s linear forwards; }
        @keyframes fall { 0% { transform: translateY(-50px) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg) scale(1.5); opacity: 0; } }
        .ping-ring { position: absolute; border: 4px solid #ff4d85; border-radius: 50%; pointer-events: none; z-index: 8; animation: pingAnim 1.5s ease-out forwards; }
        @keyframes pingAnim { 0% { width: 0; height: 0; transform: translate(-50%, -50%); opacity: 1; } 100% { width: 150px; height: 150px; transform: translate(-50%, -50%); opacity: 0; } }
    </style>
</head>
<body data-paper="solid">
    <div id="loginScreen">
        <h1>Our Canvas üíñ</h1>
        <input type="text" id="usernameInput" class="login-field" placeholder="Your Name...">
        <input type="password" id="loginInput" class="login-field" placeholder="Password...">
        <button id="loginBtn">Enter</button>
    </div>

    <div id="objectLayer"></div>
    
    <div class="top-bar">
        <button class="tool-btn" id="menuBtn">‚öôÔ∏è</button>
        <button class="tool-btn" id="chatToggleBtn">üí¨</button>
        <button class="tool-btn" id="loveBombBtn" style="background:#ffc0cb;">üíù</button>
        <button class="tool-btn" id="undoBtn" style="background:#fff0d4;">‚Ü©Ô∏è</button>
        <button class="tool-btn" id="clearBtn" style="background:#ffeaea;">üóëÔ∏è</button>
    </div>

    <div id="liveChatContainer" style="display:none;">
        <div id="liveChatMessages"></div>
        <div id="liveChatInputArea">
            <input type="text" id="liveChatInput" placeholder="Say something..." autocomplete="off">
            <button id="liveSendBtn">Send</button>
        </div>
    </div>

    <div class="settings-modal" id="settingsMenu">
        <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span>üñºÔ∏è Coloring Pages</span>
            <div class="template-grid">
                <button class="template-btn" onclick="loadTemplate('üíñ')">üíñ</button>
                <button class="template-btn" onclick="loadTemplate('‚≠ê')">‚≠ê</button>
                <button class="template-btn" onclick="loadTemplate('üê±')">üê±</button>
                <button class="template-btn" onclick="loadTemplate('üå∏')">üå∏</button>
            </div>
        </div>
        <div class="setting-row"><span>Dark UI</span><button id="darkModeBtn">üåô Toggle</button></div>
        <div class="setting-row"><span>Paper</span>
            <select id="bgPatternPicker">
                <option value="solid">Solid</option>
                <option value="bg-lined">Lined</option>
                <option value="bg-grid">Grid</option>
                <option value="bg-dots">Dots</option>
                <option value="bg-vintage">Vintage</option>
                <option value="bg-blueprint">Blueprint</option>
                <option value="bg-kraft">Kraft Card</option>
            </select>
        </div>
        <div class="setting-row"><span>Canvas Color</span><input type="color" id="bgColorPicker" value="#ffffff"></div>
        <div class="setting-row"><span>Save PNG</span><button id="saveBtn">üíæ Save</button></div>
    </div>

    <div class="sub-bar show" id="menu-brushes">
        <div class="tool-group"><span>Color</span><input type="color" id="colorPicker" value="#000000"></div>
        <div class="tool-group"><span>Copy</span><button class="tool-btn" id="eyedropBtn" style="background:#e3f2fd;">üíß</button></div>
        
        <div class="tool-group"><span>Size</span><input type="range" id="brushSize" min="1" max="50" value="5"></div>
        <div class="tool-group"><span>Fade</span><input type="range" id="brushOpacity" min="1" max="100" value="100"></div>
        <div class="tool-group"><span>Pen</span><button class="tool-btn active-tool" id="penBtn">üñãÔ∏è</button></div>
        <div class="tool-group"><span>Rainbow</span><button class="tool-btn" id="rainbowBtn" style="background:linear-gradient(to right, red,orange,yellow,green,blue,violet);">üåà</button></div>
        <div class="tool-group"><span>Stardust</span><button class="tool-btn" id="stardustBtn" style="background:#fff9c4;">üå†</button></div>
        <div class="tool-group"><span>Neon</span><button class="tool-btn" id="neonBtn">‚ú®</button></div>
        <div class="tool-group"><span>Laser</span><button class="tool-btn" id="laserBtn" style="background:#ffcdd2;">‚òÑÔ∏è</button></div>
        <div class="tool-group"><span>High</span><button class="tool-btn" id="highlightBtn">üñçÔ∏è</button></div>
    </div>

    <div class="sub-bar" id="menu-elements">
        <div class="tool-group"><span>Stamp</span><button class="tool-btn" id="stampBtn">üíñ</button></div>
        <div class="tool-group"><span style="visibility:hidden">P</span><select id="emojiPicker"><option value="‚ù§Ô∏è">‚ù§Ô∏è</option><option value="‚≠ê">‚≠ê</option><option value="üòÇ">üòÇ</option></select></div>
        <div class="tool-group"><span>Shape</span><button class="tool-btn" id="shapeBtn">üü¶</button></div>
        <div class="tool-group"><span style="visibility:hidden">P</span><select id="shapePicker"><option value="rect">Rect</option><option value="circle">Circ</option></select></div>
        <div class="tool-group"><span>Text</span><button class="tool-btn" id="textBtn">üî§</button></div>
        <div class="tool-group"><span>Type</span><input type="text" id="textInput" placeholder="Write here..."></div>
        <div class="tool-group"><span>Font</span>
            <select id="fontPicker">
                <option value="system-ui">Modern</option>
                <option value="'Comic Sans MS', cursive">Playful</option>
                <option value="Georgia, serif">Elegant</option>
                <option value="monospace">Typewriter</option>
            </select>
        </div>
        <div class="tool-group"><span>Photo</span><button class="tool-btn" id="imageBtn" onclick="document.getElementById('imageLoader').click();">üì∑</button><input type="file" id="imageLoader" accept="image/*"></div>
    </div>

    <div class="sub-bar" id="menu-magic">
        <div class="tool-group"><span>Mandala</span><button class="tool-btn" id="mandalaBtn" style="background:#f3e5f5;">‚ùÑÔ∏è</button></div>
        <div class="tool-group"><span>Mirror</span><button class="tool-btn" id="mirrorBtn" style="background:#e0f7fa;">ü¶ã</button></div>
        <div class="tool-group"><span>Radar</span><button class="tool-btn" id="pingBtn" style="background:#ffc0cb;">üéØ</button></div>
        <div class="tool-group"><span>Foil</span><button class="tool-btn" id="foilBtn" style="background:#e0e0e0;">ü™ô</button></div>
        <div class="tool-group"><span>Scratch</span><button class="tool-btn" id="scratchBtn" style="background:#bcaaa4;">‚õèÔ∏è</button></div>
        <div class="tool-group"><span>Behind</span><button class="tool-btn" id="magicBtn" style="background:#ffe0f0;">ü™Ñ</button></div>
    </div>

    <div class="sub-bar" id="menu-tools">
        <div class="tool-group"><span>Fill</span><button class="tool-btn" id="fillBtn" style="background:#d4f1ff;">ü™£</button></div>
        <div class="tool-group"><span>Eraser</span><button class="tool-btn" id="eraserBtn">üßΩ</button></div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active-nav" onclick="switchNav('menu-brushes', this)">üñåÔ∏è Brushes</button>
        <button class="nav-btn" onclick="switchNav('menu-elements', this)">üß© Elements</button>
        <button class="nav-btn" onclick="switchNav('menu-magic', this)">‚ú® Magic</button>
        <button class="nav-btn" onclick="switchNav('menu-tools', this)">üß∞ Tools</button>
    </div>

    <canvas id="drawingBoard"></canvas>
    <canvas id="scratchBoard"></canvas>
    <canvas id="laserBoard"></canvas>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); let myName = "Artist";
        socket.on('connect', () => { if (document.getElementById('loginScreen').style.display === 'none') { socket.emit('joinRoom', { roomCode: 'kushu', username: myName }); } });

        function switchNav(menuId, btnElem) { document.querySelectorAll('.sub-bar').forEach(bar => bar.classList.remove('show')); document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active-nav')); document.getElementById(menuId).classList.add('show'); btnElem.classList.add('active-nav'); }
        document.getElementById('loginBtn').addEventListener('click', () => { if (document.getElementById('loginInput').value.toLowerCase() === 'kushu') { myName = document.getElementById('usernameInput').value.trim() || "Artist"; document.getElementById('loginScreen').style.display = 'none'; socket.emit('joinRoom', { roomCode: 'kushu', username: myName }); } else alert("Wrong password! Hint: it's kushu üò∏"); });

        const liveChatContainer = document.getElementById('liveChatContainer');
        document.getElementById('chatToggleBtn').addEventListener('click', () => liveChatContainer.style.display = liveChatContainer.style.display === 'none' ? 'flex' : 'none');
        function addLiveMessage(text, sender) { const msgEl = document.createElement('div'); msgEl.className = 'live-msg'; msgEl.innerHTML = `<strong>${sender}:</strong> ${text}`; document.getElementById('liveChatMessages').appendChild(msgEl); document.getElementById('liveChatMessages').scrollTop = document.getElementById('liveChatMessages').scrollHeight; setTimeout(() => { msgEl.classList.add('fade-out'); setTimeout(() => msgEl.remove(), 1000); }, 7000); }
        document.getElementById('liveSendBtn').addEventListener('click', () => { const text = document.getElementById('liveChatInput').value.trim(); if (text) { addLiveMessage(text, myName); socket.emit('chatMessage', { text: text }); document.getElementById('liveChatInput').value = ''; } });
        socket.on('chatMessage', (data) => addLiveMessage(data.text, data.sender));

        function triggerLoveBomb(emit) { const emojis = ['üíñ', '‚ú®', 'üå∏', 'üíù', 'üéâ']; for(let i=0; i<40; i++) { const heart = document.createElement('div'); heart.className = 'love-heart'; heart.innerText = emojis[Math.floor(Math.random() * emojis.length)]; heart.style.left = Math.random() * 100 + 'vw'; heart.style.animationDuration = (Math.random() * 2 + 2) + 's'; document.body.appendChild(heart); setTimeout(() => heart.remove(), 4000); } if(emit) socket.emit('loveBomb'); }
        document.getElementById('loveBombBtn').addEventListener('click', () => triggerLoveBomb(true)); socket.on('loveBomb', () => triggerLoveBomb(false));
        function triggerPing(x, y, emit) { const ping = document.createElement('div'); ping.className = 'ping-ring'; ping.style.left = x + 'px'; ping.style.top = y + 'px'; document.body.appendChild(ping); setTimeout(() => ping.remove(), 1500); if(emit) socket.emit('pingRadar', {x, y}); }
        socket.on('pingRadar', (data) => triggerPing(data.x, data.y, false));

        // üñºÔ∏è UPDATED OBJECT ENGINE: Now With Resizing!
        const objLayer = document.getElementById('objectLayer');
        
        function createObject(id, type, content, x, y, options, emit) {
            const el = document.createElement(type === 'img' ? 'img' : 'div');
            el.id = id; el.className = `canvas-obj ${type}-obj`;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            el.dataset.scale = options.scale || 1;
            el.style.transform = `translate(-50%, -50%) scale(${el.dataset.scale})`;
            
            if (type === 'text') { el.innerText = content; el.style.color = options.color; el.style.fontFamily = options.font; el.style.fontSize = options.size + 'px'; } 
            else if (type === 'img') { el.src = content; el.style.width = options.width + 'px'; }

            // Delete Button
            const delBtn = document.createElement('button'); delBtn.className = 'delete-btn'; delBtn.innerText = '‚úï';
            delBtn.onclick = (e) => { e.stopPropagation(); el.remove(); socket.emit('deleteObj', id); };
            
            // Resize Button ‚§°
            const resBtn = document.createElement('button'); resBtn.className = 'resize-btn'; resBtn.innerText = '‚§°';
            
            if(type !== 'img') { el.appendChild(delBtn); el.appendChild(resBtn); } 
            else { /* Images handled via wrapper if needed, or simplify by wrapping img in div */
                const wrapper = document.createElement('div'); wrapper.className = 'canvas-obj img-obj';
                wrapper.id = id; wrapper.style.left = x + 'px'; wrapper.style.top = y + 'px';
                wrapper.dataset.scale = el.dataset.scale; wrapper.style.transform = el.style.transform;
                el.className = ''; el.style.position='relative'; el.style.transform='none';
                wrapper.appendChild(el); wrapper.appendChild(delBtn); wrapper.appendChild(resBtn);
                objLayer.appendChild(wrapper);
                setupInteractions(wrapper, id, resBtn); return;
            }

            objLayer.appendChild(el);
            setupInteractions(el, id, resBtn);
            if(emit) socket.emit('addObj', {id, type, content, x, y, options});
        }

        function setupInteractions(el, id, resBtn) {
            let isDraggingObj = false, isResizing = false, offsetX, offsetY, startY, startScale;
            
            // Drag Logic
            el.addEventListener('touchstart', (e) => {
                if(e.target === resBtn) return; // Let resize handle it
                e.stopPropagation(); document.querySelectorAll('.canvas-obj').forEach(o => o.classList.remove('selected')); el.classList.add('selected');
                isDraggingObj = true; const touch = e.touches[0]; offsetX = touch.clientX - el.offsetLeft; offsetY = touch.clientY - el.offsetTop;
            }, {passive: false});

            el.addEventListener('touchmove', (e) => {
                if(!isDraggingObj) return; e.preventDefault(); e.stopPropagation();
                const touch = e.touches[0]; const nx = touch.clientX - offsetX, ny = touch.clientY - offsetY;
                el.style.left = nx + 'px'; el.style.top = ny + 'px'; socket.emit('moveObj', {id, x: nx, y: ny}); 
            }, {passive: false});

            el.addEventListener('touchend', (e) => { e.stopPropagation(); isDraggingObj = false; });

            // ‚§° Resize Logic (Drag down to enlarge, up to shrink)
            resBtn.addEventListener('touchstart', (e) => {
                e.stopPropagation(); isResizing = true;
                startY = e.touches[0].clientY; startScale = parseFloat(el.dataset.scale);
            }, {passive: false});

            resBtn.addEventListener('touchmove', (e) => {
                if(!isResizing) return; e.preventDefault(); e.stopPropagation();
                const dy = e.touches[0].clientY - startY;
                const newScale = Math.max(0.2, startScale + dy * 0.01); // 0.01 controls sensitivity
                el.dataset.scale = newScale;
                el.style.transform = `translate(-50%, -50%) scale(${newScale})`;
                socket.emit('scaleObj', {id, scale: newScale});
            }, {passive: false});

            resBtn.addEventListener('touchend', (e) => { e.stopPropagation(); isResizing = false; });
        }

        document.body.addEventListener('touchstart', (e) => {
            if(!e.target.closest('.canvas-obj')) document.querySelectorAll('.canvas-obj').forEach(o => o.classList.remove('selected'));
        });

        socket.on('addObj', (d) => createObject(d.id, d.type, d.content, d.x, d.y, d.options, false));
        socket.on('moveObj', (d) => { const el = document.getElementById(d.id); if(el) { el.style.left = d.x + 'px'; el.style.top = d.y + 'px'; } });
        socket.on('scaleObj', (d) => { const el = document.getElementById(d.id); if(el) { el.dataset.scale = d.scale; el.style.transform = `translate(-50%, -50%) scale(${d.scale})`; } });
        socket.on('deleteObj', (id) => { const el = document.getElementById(id); if(el) el.remove(); });
        const canvas = document.getElementById('drawingBoard'); const ctx = canvas.getContext('2d');
        const scratchBoard = document.getElementById('scratchBoard'); const ctxScratch = scratchBoard.getContext('2d');
        const laserBoard = document.getElementById('laserBoard'); const ctxLaser = laserBoard.getContext('2d');
        
        function resizeCanvas() { const w = window.innerWidth, h = window.innerHeight; canvas.width = w; canvas.height = h; scratchBoard.width = w; scratchBoard.height = h; laserBoard.width = w; laserBoard.height = h; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        setInterval(() => { ctxLaser.fillStyle = "rgba(0,0,0,0.1)"; ctxLaser.globalCompositeOperation = "destination-out"; ctxLaser.fillRect(0, 0, laserBoard.width, laserBoard.height); ctxLaser.globalCompositeOperation = "source-over"; }, 50);

        let isDrawing = false, currentX = 0, currentY = 0;
        let isEraser=false, isStamping=false, isTextMode=false, isHighlight=false, isNeon=false, isShapeMode=false, isFillMode=false, isMagicMode=false, isMirrorMode=false, isLaserMode=false, isRainbow=false, isStardust=false, isPingMode=false, isScratchMode=false, isEyedropper=false, isMandala=false;
        let rainbowHue = 0; let stardustDistance = 0; let lastPointerEmit = 0; 

        const toolBtns = ['penBtn','rainbowBtn','stardustBtn','laserBtn','highlightBtn','neonBtn','mirrorBtn','mandalaBtn','stampBtn','shapeBtn','textBtn','pingBtn','scratchBtn','magicBtn','fillBtn','eraserBtn','eyedropBtn'];
        function resetTools() { isEraser=isStamping=isTextMode=isHighlight=isNeon=isShapeMode=isFillMode=isMagicMode=isMirrorMode=isLaserMode=isRainbow=isStardust=isPingMode=isScratchMode=isEyedropper=isMandala=false; toolBtns.forEach(id => { const el = document.getElementById(id); if(el) el.classList.remove('active-tool'); }); }
        const mapBtn = (id, flagSetter) => { const el = document.getElementById(id); if(el) el.addEventListener('click', () => { resetTools(); flagSetter(); el.classList.add('active-tool'); }); };
        
        mapBtn('penBtn', () => {}); mapBtn('eraserBtn', () => isEraser = true); mapBtn('rainbowBtn', () => isRainbow = true); mapBtn('stardustBtn', () => isStardust = true); mapBtn('laserBtn', () => isLaserMode = true); mapBtn('highlightBtn', () => isHighlight = true); mapBtn('neonBtn', () => isNeon = true); mapBtn('mirrorBtn', () => isMirrorMode = true); mapBtn('mandalaBtn', () => isMandala = true); mapBtn('stampBtn', () => isStamping = true); mapBtn('shapeBtn', () => isShapeMode = true); mapBtn('textBtn', () => isTextMode = true); mapBtn('pingBtn', () => isPingMode = true); mapBtn('scratchBtn', () => isScratchMode = true); mapBtn('magicBtn', () => isMagicMode = true); mapBtn('fillBtn', () => isFillMode = true); mapBtn('eyedropBtn', () => isEyedropper = true);
        
        function applyFoil(emit) { ctxScratch.fillStyle = "#C0C0C0"; ctxScratch.fillRect(0, 0, scratchBoard.width, scratchBoard.height); if(emit) socket.emit('foil'); }
        document.getElementById('foilBtn').addEventListener('click', () => applyFoil(true)); socket.on('foil', () => applyFoil(false));
        function eraseFoil(x, y, size, emit) { ctxScratch.globalCompositeOperation = 'destination-out'; ctxScratch.beginPath(); ctxScratch.arc(x, y, size * 2, 0, Math.PI * 2); ctxScratch.fill(); ctxScratch.closePath(); ctxScratch.globalCompositeOperation = 'source-over'; if(emit) socket.emit('scratch', {x,y,size}); }
        socket.on('scratch', (d) => eraseFoil(d.x, d.y, d.size, false));

        function getTouchPos(e) { const rect = canvas.getBoundingClientRect(); return { x: Math.floor(e.touches[0].clientX - rect.left), y: Math.floor(e.touches[0].clientY - rect.top) }; }
        let isDraggingItem = false, dragType = '', dragData = {}, savedImageData = null, lastX = 0, lastY = 0;

        canvas.addEventListener('touchstart', (e) => {
            if(e.target === canvas) { e.preventDefault(); document.getElementById('settingsMenu').classList.remove('show'); } 
            const pos = getTouchPos(e); lastX = pos.x; lastY = pos.y; currentX = pos.x; currentY = pos.y; 
            socket.emit('pointer', {x: pos.x, y: pos.y});
            
            // üíß EYEDROPPER LOGIC
            if (isEyedropper) {
                const px = ctx.getImageData(pos.x, pos.y, 1, 1).data;
                if (px[3] > 0) { // If pixel is not transparent
                    const hex = "#" + [...px].slice(0,3).map(x=>x.toString(16).padStart(2,'0')).join('');
                    document.getElementById('colorPicker').value = hex;
                }
                resetTools(); document.getElementById('penBtn').classList.add('active-tool'); return;
            }

            if (isPingMode) { triggerPing(pos.x, pos.y, true); return; }
            if (isScratchMode) { eraseFoil(pos.x, pos.y, brushSize.value, true); isDrawing = true; return; }
            if (isFillMode) return; 
            
            if (isTextMode) {
                const txt = document.getElementById('textInput').value; if (!txt) return;
                createObject('txt_' + Date.now(), 'text', txt, pos.x, pos.y, { color: document.getElementById('colorPicker').value, font: document.getElementById('fontPicker').value, size: document.getElementById('brushSize').value * 4, scale: 1 }, true); return;
            }
            if (isStamping || isShapeMode) {
                isDraggingItem = true; dragType = isShapeMode ? 'shape' : 'stamp'; savedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                if (isStamping) dragData = { emoji: document.getElementById('emojiPicker').value, size: document.getElementById('brushSize').value * 4, alpha: document.getElementById('brushOpacity').value / 100 };
                else dragData = { type: document.getElementById('shapePicker').value, color: document.getElementById('colorPicker').value, size: document.getElementById('brushSize').value, neon: isNeon };
                return; 
            }
            isDrawing = true; 
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if(e.target === canvas) e.preventDefault();
            const pos = getTouchPos(e); 
            if (Date.now() - lastPointerEmit > 50) { socket.emit('pointer', {x: pos.x, y: pos.y}); lastPointerEmit = Date.now(); }

            if (isDraggingItem) {
                ctx.putImageData(savedImageData, 0, 0); 
                if (dragType === 'stamp') drawStamp(pos.x, pos.y, dragData.emoji, dragData.size, false, dragData.alpha); else if (dragType === 'shape') drawShape(dragData.type, currentX, currentY, pos.x, pos.y, dragData.color, dragData.size, false, dragData.neon);
                lastX = pos.x; lastY = pos.y; return;
            }
            if (!isDrawing) return;
            if (isScratchMode) { eraseFoil(pos.x, pos.y, brushSize.value, true); return; }

            let activeColor = document.getElementById('colorPicker').value;
            if (isRainbow) { rainbowHue = (rainbowHue + 3) % 360; activeColor = `hsl(${rainbowHue}, 100%, 50%)`; }
            if (isStardust) {
                const dx = pos.x - currentX; const dy = pos.y - currentY; stardustDistance += Math.sqrt(dx*dx + dy*dy);
                if (stardustDistance > brushSize.value * 2) { drawStamp(pos.x, pos.y, '‚ú®', brushSize.value * 2, true, 1.0); stardustDistance = 0; }
                currentX = pos.x; currentY = pos.y; return;
            }

            const alpha = isHighlight ? 0.3 : (document.getElementById('brushOpacity').value / 100);
            ctx.globalCompositeOperation = isEraser ? 'destination-out' : (isMagicMode ? 'destination-over' : 'source-over'); ctx.globalAlpha = alpha; 
            
            drawLine(currentX, currentY, pos.x, pos.y, activeColor, brushSize.value, true, isEraser, isHighlight, isNeon, isMagicMode, isLaserMode, alpha);
            
            if (isMirrorMode && !isEraser && !isMagicMode && !isLaserMode) { drawLine(canvas.width - currentX, currentY, canvas.width - pos.x, pos.y, activeColor, brushSize.value, true, false, isHighlight, isNeon, false, false, alpha); }
            
            // ‚ùÑÔ∏è NEW: MANDALA KALEIDOSCOPE!
            if (isMandala && !isEraser && !isMagicMode && !isLaserMode) {
                const cx = canvas.width / 2, cy = canvas.height / 2;
                const dx0 = currentX - cx, dy0 = currentY - cy, dx1 = pos.x - cx, dy1 = pos.y - cy;
                for (let i = 1; i < 8; i++) {
                    const angle = i * Math.PI / 4; const cos = Math.cos(angle), sin = Math.sin(angle);
                    drawLine(cx + dx0*cos - dy0*sin, cy + dx0*sin + dy0*cos, cx + dx1*cos - dy1*sin, cy + dx1*sin + dy1*cos, activeColor, brushSize.value, true, false, isHighlight, isNeon, false, false, alpha);
                }
            }

            currentX = pos.x; currentY = pos.y;
        }, { passive: false });

        canvas.addEventListener('touchend', () => {
            if (isDraggingItem) { isDraggingItem = false; if (dragType === 'stamp') socket.emit('stamp', { emoji: dragData.emoji, x: lastX, y: lastY, size: dragData.size, alpha: dragData.alpha }); else if (dragType === 'shape') socket.emit('shape', { type: dragData.type, x0: currentX, y0: currentY, x1: lastX, y1: lastY, color: dragData.color, size: dragData.size, neon: dragData.neon }); return; }
            isDrawing = false; ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;
        });

        function drawLine(x0, y0, x1, y1, color, size, emit, erasing, highlight, neon, magic, laser, alpha) { const activeCtx = laser ? ctxLaser : ctx; activeCtx.beginPath(); activeCtx.moveTo(x0, y0); activeCtx.lineTo(x1, y1); activeCtx.strokeStyle = color; activeCtx.lineWidth = size; activeCtx.lineCap = 'round'; if (neon || laser) { activeCtx.shadowBlur = size * 2; activeCtx.shadowColor = color; } else { activeCtx.shadowBlur = 0; } activeCtx.stroke(); activeCtx.closePath(); activeCtx.shadowBlur = 0; if (emit) socket.emit('drawing', { x0, y0, x1, y1, color, size, erasing, highlight, neon, magic, laser, alpha }); }
        socket.on('drawing', (data) => { const activeCtx = data.laser ? ctxLaser : ctx; activeCtx.globalCompositeOperation = data.erasing ? 'destination-out' : (data.magic ? 'destination-over' : 'source-over'); activeCtx.globalAlpha = data.alpha || 1.0; drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.size, false, data.erasing, data.highlight, data.neon, data.magic, data.laser, data.alpha); activeCtx.globalCompositeOperation = 'source-over'; activeCtx.globalAlpha = 1.0; activeCtx.shadowBlur = 0; });
        function drawStamp(x, y, emoji, size, emit, alpha) { ctx.globalAlpha = alpha || 1.0; ctx.font = `${size}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = "black"; ctx.fillText(emoji, x, y); ctx.globalAlpha = 1.0; if (emit) socket.emit('stamp', { x, y, emoji, size, alpha }); } socket.on('stamp', (d) => drawStamp(d.x, d.y, d.emoji, d.size, false, d.alpha));
        function drawShape(t, x0, y0, x1, y1, c, s, emit, n) { ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = s; ctx.lineCap = 'round'; if(n) {ctx.shadowBlur = s*2; ctx.shadowColor=c;} if (t === 'rect') ctx.rect(x0, y0, x1 - x0, y1 - y0); else if (t === 'circle') ctx.arc(x0, y0, Math.hypot(x1 - x0, y1 - y0), 0, 2 * Math.PI); else if (t === 'line') { ctx.moveTo(x0, y0); ctx.lineTo(x1, y1); } ctx.stroke(); ctx.closePath(); ctx.shadowBlur=0; if (emit) socket.emit('shape', { type: t, x0, y0, x1, y1, color: c, size: s, neon: n }); } socket.on('shape', (d) => drawShape(d.type, d.x0, d.y0, d.x1, d.y1, d.color, d.size, false, d.neon));

        // BUG FIX: Papers now use attributes so they don't break Dark Mode!
        document.getElementById('bgPatternPicker').addEventListener('change', (e) => { const val = e.target.value; document.body.setAttribute('data-paper', val); socket.emit('bgPattern', val); });
        socket.on('bgPattern', (val) => { document.body.setAttribute('data-paper', val); document.getElementById('bgPatternPicker').value = val; });
        document.getElementById('darkModeBtn').addEventListener('click', () => document.body.classList.toggle('dark-ui'));
        
        document.getElementById('menuBtn').addEventListener('click', () => document.getElementById('settingsMenu').classList.toggle('show'));
        document.getElementById('bgColorPicker').addEventListener('input', (e) => { document.body.style.backgroundColor = e.target.value; socket.emit('bgColor', e.target.value); });
        socket.on('bgColor', (color) => { document.getElementById('bgColorPicker').value = color; document.body.style.backgroundColor = color; });
        
        let history = []; const MAX_HISTORY = 10;
        function saveState() { history.push(canvas.toDataURL()); if (history.length > MAX_HISTORY) history.shift(); }
        function performUndo(emit) { if (history.length > 1) { history.pop(); const img = new Image(); img.src = history[history.length - 1]; img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); }; if (emit) socket.emit('undo'); } }
        document.getElementById('undoBtn').addEventListener('click', () => performUndo(true)); socket.on('undo', () => performUndo(false));
        document.getElementById('clearBtn').addEventListener('click', () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctxScratch.clearRect(0,0,scratchBoard.width,scratchBoard.height); objLayer.innerHTML=''; socket.emit('clear'); }); socket.on('clear', () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctxScratch.clearRect(0,0,scratchBoard.width,scratchBoard.height); objLayer.innerHTML=''; });

        document.getElementById('imageLoader').addEventListener('change', function(e) { const reader = new FileReader(); reader.onload = function(event) { const img = new Image(); img.onload = function() { const maxDim = window.innerWidth * 0.6; let scale = 1; if (img.width > maxDim) scale = maxDim / img.width; const w = img.width * scale; createObject('img_' + Date.now(), 'img', tempC.toDataURL('image/jpeg', 0.8), window.innerWidth/2, window.innerHeight/2, {width: w, scale: 1}, true); }; 
            const tempC = document.createElement('canvas'); const tCtx = tempC.getContext('2d');
            img.src = event.target.result; img.onload = () => { let scale = Math.min(window.innerWidth * 0.6 / img.width, 1); tempC.width = img.width * scale; tempC.height = img.height * scale; tCtx.drawImage(img, 0, 0, tempC.width, tempC.height); createObject('img_' + Date.now(), 'img', tempC.toDataURL('image/jpeg', 0.8), window.innerWidth/2, window.innerHeight/2, {width: tempC.width, scale: 1}, true); }
        }; if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]); }, false);
    </script>
</body>
</html>
